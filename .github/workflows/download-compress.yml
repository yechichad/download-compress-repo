name: Download and Double Compress

on:
  workflow_dispatch:
    inputs:
      download_url:
        description: '×§×™×©×•×¨ ×œ×”×•×¨×“×”'
        required: true
        type: string

jobs:
  download-and-compress:
    runs-on: ubuntu-latest
    
    steps:
      - name: Test internet connectivity
        run: |
          echo "×‘×•×“×§ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜..."
          ping -c 3 google.com || echo "××–×”×¨×”: ×‘×¢×™×” ×‘×—×™×‘×•×¨"
      
      - name: Install yt-dlp for YouTube downloads
        run: |
          echo "××ª×§×™×Ÿ yt-dlp ×œ×¡×¨×˜×•× ×™ ×™×•×˜×™×•×‘..."
          sudo apt-get update
          sudo apt-get install -y python3-pip ffmpeg
          pip3 install -U yt-dlp
          
      - name: Download file
        run: |
          echo "====================================="
          echo "××•×¨×™×“ ××”×§×™×©×•×¨: ${{ github.event.inputs.download_url }}"
          echo "====================================="
          
          URL="${{ github.event.inputs.download_url }}"
          
          # ×‘×“×™×§×” ×× ×–×” ×§×™×©×•×¨ ×™×•×˜×™×•×‘
          if [[ "$URL" =~ youtube\.com|youtu\.be ]]; then
            echo "ğŸ¥ ×–×•×”×” ×§×™×©×•×¨ ×™×•×˜×™×•×‘ - ××©×ª××© ×‘-yt-dlp"
            echo "××•×¨×™×“ ×‘×¤×•×¨××˜ ×”×˜×•×‘ ×‘×™×•×ª×¨..."
            
            if yt-dlp -f "bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best"                       --merge-output-format mp4                       -o "downloaded_file.%(ext)s"                       --no-playlist                       --progress                       "$URL"; then
              echo "âœ… ×”×•×¨×“×ª ×™×•×˜×™×•×‘ ×”×¦×œ×™×—×”!"
              # ××¦× ××ª ×”×§×•×‘×¥ ×©×”×•×¨×“
              DOWNLOADED=$(ls downloaded_file.* 2>/dev/null | head -n1)
              if [ -n "$DOWNLOADED" ]; then
                mv "$DOWNLOADED" downloaded_file
              fi
            else
              echo "âŒ ×”×•×¨×“×ª ×™×•×˜×™×•×‘ × ×›×©×œ×”!"
              echo "×‘×“×•×§:"
              echo "1. ×”×§×™×©×•×¨ ×ª×§×™×Ÿ (×™×•×˜×™×•×‘ ×‘×œ×‘×“, ×œ× playlists)"
              echo "2. ×”×¡×¨×˜×•×Ÿ ×œ× ×¤×¨×˜×™ ××• ××•×’×‘×œ ×’×™××•×’×¨×¤×™×ª"
              echo "3. ×™×© ×—×™×‘×•×¨ ××™× ×˜×¨× ×˜ ×ª×§×™×Ÿ"
              exit 1
            fi
          else
            # ×”×•×¨×“×” ×¨×’×™×œ×” (×œ× ×™×•×˜×™×•×‘)
            echo "ğŸ“¥ ×”×•×¨×“×” ×¨×’×™×œ×” ×©×œ ×§×•×‘×¥..."
            
            # × ×™×¡×™×•×Ÿ ×¢× wget
            if wget --timeout=30 --tries=3 -O downloaded_file "$URL"; then
              echo "âœ… ×”×•×¨×“×” ×”×¦×œ×™×—×” ×¢× wget"
            # × ×™×¡×™×•×Ÿ ×¢× curl
            elif curl -L --connect-timeout 30 --max-time 300 -o downloaded_file "$URL"; then
              echo "âœ… ×”×•×¨×“×” ×”×¦×œ×™×—×” ×¢× curl"
            # × ×™×¡×™×•×Ÿ ×¢× python
            elif python3 -c "import urllib.request; urllib.request.urlretrieve('$URL', 'downloaded_file')"; then
              echo "âœ… ×”×•×¨×“×” ×”×¦×œ×™×—×” ×¢× python"
            else
              echo "âŒ ×›×œ ×©×™×˜×•×ª ×”×”×•×¨×“×” × ×›×©×œ×•!"
              echo "×‘×“×•×§:"
              echo "1. ×”×§×™×©×•×¨ ×ª×§×™×Ÿ ×•×–××™×Ÿ"
              echo "2. ××™×Ÿ ×—×¡×™××” ×©×œ NetFree ××• ×¤×™×™×¨×•×•×œ"
              echo "3. ×”×§×•×‘×¥ ×§×™×™× ×•× ×’×™×©"
              exit 1
            fi
          fi
          
          echo "====================================="
          echo "×¤×¨×˜×™ ×”×§×•×‘×¥ ×©×”×•×¨×“:"
          ls -lh downloaded_file
          file downloaded_file
          echo "====================================="
      
      - name: First compression
        run: |
          echo "×“×—×™×¡×” ×¨××©×•× ×”..."
          zip -r first_compress.zip downloaded_file
          echo "×’×•×“×œ ×œ××—×¨ ×“×—×™×¡×” ×¨××©×•× ×”:"
          ls -lh first_compress.zip
      
      - name: Second compression
        run: |
          echo "×“×—×™×¡×” ×©× ×™×™×” (×“×—×™×¡×” ×›×¤×•×œ×”)..."
          zip -r final_double_compressed.zip first_compress.zip
          echo "×’×•×“×œ ×¡×•×¤×™:"
          ls -lh final_double_compressed.zip
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: double-compressed-file
          path: final_double_compressed.zip
          retention-days: 1
